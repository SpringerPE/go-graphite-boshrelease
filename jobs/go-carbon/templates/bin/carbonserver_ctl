#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
source /var/vcap/jobs/go-carbon/helpers/ctl_setup.sh 'go-carbon' 'carbonserver'

case $1 in
  start)
    echo "Starting carbonserver: $(date) ..."
    pid_guard $PIDFILE $JOB_NAME
    (
        {
            exec chpst -v -u vcap:vcap \
            /var/vcap/jobs/go-carbon/packages/carbonserver/bin/carbonserver \
                -i <%= p("carbonserver.duration") %> \
                -maxprocs <%= p("carbonserver.maxprocs") %> \
                -p <%= p("carbonserver.port") %> \
                -w "${STORE_DIR}/whisper/" \
                -logdir ${LOG_DIR}
        } 2>&1
    ) &
    echo $! > $PIDFILE
    ;;
  stop)
    echo "Stopping carbonserver $(date) ..."
    kill_and_wait $PIDFILE
    ;;
  *)
    echo "Usage: carbonserver_ctl {start|stop}"
    ;;
esac

exit 0
