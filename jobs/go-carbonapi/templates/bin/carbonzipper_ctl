#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
source /var/vcap/jobs/go-carbonapi/helpers/ctl_setup.sh 'go-carbonapi' 'carbonzipper'

case $1 in
  start)
    echo "Starting carbonzipper: $(date) ..."
    pid_guard $PIDFILE $JOB_NAME
    (
        {
            exec chpst -v -u vcap:vcap \
            /var/vcap/jobs/go-carbonapi/packages/carbonzipper/bin/carbonzipper \
                -c /var/vcap/jobs/go-carbonapi/config/carbonzipper.json \
                -i <%= p("carbonzipper.duration") %> \
                -maxprocs <%= p("carbonzipper.maxprocs") %> \
                -p <%= p("carbonzipper.port") %> \
                -logdir ${LOG_DIR}
        } 2>&1
    ) &
    echo $! > $PIDFILE
    ;;
  stop)
    echo "Stopping carbonzipper $(date) ..."
    kill_and_wait $PIDFILE
    ;;
  *)
    echo "Usage: carbonzipper_ctl {start|stop}"
    ;;
esac

exit 0
